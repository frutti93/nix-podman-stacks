name: "Build"
on:
  workflow_dispatch:
  pull_request:
    paths:
      - "**.nix"
      - "flake.lock"
      - ".github/workflows/ci.yaml"
      - "images/**"
      - "**.md"
  push:
    branches:
      - main
    paths:
      - "**.nix"
      - "flake.lock"
      - ".github/workflows/ci.yaml"
      - "images/**"
      - "**.md"

jobs:
  detect-changed-images:
    name: Detect changed container images
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request'
    outputs:
      images: ${{ steps.diff-images.outputs.images }}
      has_changes: ${{ steps.diff-images.outputs.has_changes }}
    steps:
      - name: Checkout PR
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Extract and compare images
        id: diff-images
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          else
            BASE_SHA="$(git rev-parse HEAD^)"
            HEAD_SHA="$(git rev-parse HEAD)"
          fi

          echo "Comparing images between $BASE_SHA and $HEAD_SHA"

          # Get list of changed .nix files only
          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '\.nix

  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-24.04
    needs: detect-changed-images
    if: needs.detect-changed-images.outputs.has_changes == 'true'
    permissions:
      security-events: write
      pull-requests: write
    strategy:
      matrix:
        image: ${{ fromJSON(needs.detect-changed-images.outputs.images) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.4

      - name: Generate safe name for artifacts
        id: safe-name
        run: |
          SAFE_NAME=$(echo "${{ matrix.image }}" | sed 's|[:/\.]|_|g')
          echo "safe_name=$SAFE_NAME" >> $GITHUB_OUTPUT

      - name: Scan image
        run: |
          set -euo pipefail
          IMG="${{ matrix.image }}"
          SAFE_NAME="${{ steps.safe-name.outputs.safe_name }}"
          mkdir -p trivy-results
          
          OUTPUT_TXT="trivy-results/trivy-$SAFE_NAME.txt"
          OUTPUT_SARIF="trivy-results/trivy-$SAFE_NAME.sarif"

          echo "IMAGE=$IMG" > "$OUTPUT_TXT"

          echo "üîç Scanning $IMG (table output)"
          trivy image --exit-code 1 --severity CRITICAL,HIGH --format table "$IMG" | tee -a "$OUTPUT_TXT"

          echo "üîí Generating SARIF for $IMG"
          trivy image --format sarif --output "$OUTPUT_SARIF" "$IMG"

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-${{ steps.safe-name.outputs.safe_name }}
          path: trivy-results
          retention-days: 1

      - name: Upload SARIF results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results/trivy-${{ steps.safe-name.outputs.safe_name }}.sarif
          category: trivy-${{ matrix.image }}

  trivy-aggregate:
    name: Trivy Aggregate Results
    runs-on: ubuntu-24.04
    needs: [detect-changed-images, trivy-scan]
    if: always() && needs.detect-changed-images.outputs.has_changes == 'true'
    permissions:
      pull-requests: write
    steps:
      - name: Set scan status
        run: |
          if [[ "${{ needs.trivy-scan.result }}" == "success" ]]; then
            echo "All Trivy scans passed!"
            echo "TRIVY_STATUS=success" >> $GITHUB_ENV
          else
            echo "One or more Trivy scans failed!"
            echo "TRIVY_STATUS=failure" >> $GITHUB_ENV
          fi

      - name: Download all scan results
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v5
        with:
          pattern: trivy-results-*
          path: all-results
          merge-multiple: true

      - name: Build PR comment
        run: |
          if [[ "$TRIVY_STATUS" == "success" ]]; then
            HEADER="## ‚úÖ Container Image Security Scan Passed"
          else
            HEADER="## ‚ùå Container Image Security Scan Failed"
          fi

          BODY="$HEADER\n\nScanned the following updated images:\n"

          for f in all-results/trivy-*.txt; do
            if [ -f "$f" ]; then
              IMG=$(head -n 1 "$f" | sed 's/^IMAGE=//')
              CONTENT=$(tail -n +2 "$f")
              if [ -n "$CONTENT" ] && [ "$CONTENT" != "" ]; then
                BODY="$BODY\n\n### \`$IMG\`\n<details><summary>Vulnerabilities Found</summary>\n\n\`\`\`\n$CONTENT\n\`\`\`\n</details>"
              else
                BODY="$BODY\n\n### \`$IMG\`\n‚úÖ No vulnerabilities were detected."
              fi
            fi
          done

          BODY="$BODY\n\nüìä Check the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning?query=pr%3A${{ github.event.pull_request.number }}) for full SARIF reports."
          echo -e "$BODY" > comment.md

      - name: Comment PR with Trivy results
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: comment.md

      - name: Fail job if scans failed
        run: |
          if [[ "$TRIVY_STATUS" == "failure" ]]; then
            echo "One or more Trivy scans failed!"
            exit 1
          fi

  build-config:
    name: Build
    runs-on: ubuntu-24.04
    steps:
      - name: Free diskspace
        uses: easimon/maximize-build-space@master
        with:
          build-mount-path: /nix
          root-reserve-mb: 5120
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
      - uses: actions/checkout@v5
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: "experimental-features = nix-command flakes pipe-operators"
      - name: Restore and cache Nix store
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 1073741824
          purge: false
      - name: Build Template Config
        run: nix build ./template#homeConfigurations.myhost.activationPackage
      - name: Build Full Config
        run: nix build .#homeConfigurations.ci.activationPackage

  check_flake:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: "experimental-features = nix-command flakes pipe-operators"
      - name: Check Flake
        run: nix flake check --keep-going

  build-docs:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: "experimental-features = nix-command flakes pipe-operators"
      - name: Build docs
        run: nix build .#book -o result/book
      - name: Build search
        run: nix build .#search -o result/search
      - name: Upload docs
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./result

  publish-docs:
    needs: build-docs
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    steps:
      - uses: actions/deploy-pages@v4 || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No .nix files changed"
            echo "images=[]" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed .nix files:"
          echo "$CHANGED_FILES"
          echo ""

          # Extract images from changed lines only
          CHANGED_IMAGES=""

          while IFS= read -r file; do
            if [ -n "$file" ]; then
              echo "Processing file: $file"
              
              # Get the diff for this specific file showing added/modified lines
              ADDED_LINES=$(git diff "$BASE_SHA" "$HEAD_SHA" -- "$file" | grep '^+' | grep -v '^+++' || true)
              REMOVED_LINES=$(git diff "$BASE_SHA" "$HEAD_SHA" -- "$file" | grep '^-' | grep -v '^---' || true)
              
              # Extract images from added lines (new or changed)
              while IFS= read -r line; do
                if [ -n "$line" ]; then
                  # Remove the leading + and extract image
                  CLEAN_LINE=$(echo "$line" | sed 's/^+//')
                  IMAGE=$(echo "$CLEAN_LINE" | grep -oP 'image\s*=\s*"\K[^"]+(?=")' 2>/dev/null || true)
                  if [ -n "$IMAGE" ]; then
                    echo "  Found changed image: $IMAGE"
                    CHANGED_IMAGES=$(echo -e "$CHANGED_IMAGES\n$IMAGE")
                  fi
                fi
              done <<< "$ADDED_LINES"
              
              # Also check removed lines to catch image updates (old version -> new version)
              # We'll extract images from both removed and added lines, then find the differences
              REMOVED_IMAGES=""
              while IFS= read -r line; do
                if [ -n "$line" ]; then
                  # Remove the leading - and extract image
                  CLEAN_LINE=$(echo "$line" | sed 's/^-//')
                  IMAGE=$(echo "$CLEAN_LINE" | grep -oP 'image\s*=\s*"\K[^"]+(?=")' 2>/dev/null || true)
                  if [ -n "$IMAGE" ]; then
                    echo "  Found removed image: $IMAGE"
                    REMOVED_IMAGES=$(echo -e "$REMOVED_IMAGES\n$IMAGE")
                  fi
                fi
              done <<< "$REMOVED_LINES"
            fi
          done <<< "$CHANGED_FILES"

          # Clean up and deduplicate
          CHANGED_IMAGES=$(echo "$CHANGED_IMAGES" | grep -v '^

  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-24.04
    needs: detect-changed-images
    if: needs.detect-changed-images.outputs.has_changes == 'true'
    permissions:
      security-events: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.4

      - name: Scan changed images
        run: |
          set -euo pipefail
          IMAGES='${{ needs.detect-changed-images.outputs.images }}'
          mkdir -p trivy-results
          FAIL=0

          for IMG in $(echo "$IMAGES" | jq -r '.[]'); do
            SAFE_NAME=$(echo "$IMG" | sed 's|[:/\.]|_|g')
            OUTPUT_TXT="trivy-results/trivy-$SAFE_NAME.txt"
            OUTPUT_SARIF="trivy-results/trivy-$SAFE_NAME.sarif"

            echo "IMAGE=$IMG" > "$OUTPUT_TXT"

            echo "üîç Scanning $IMG (table output)"
            if ! trivy image --exit-code 1 --severity CRITICAL,HIGH --format table "$IMG" | tee -a "$OUTPUT_TXT"; then
              FAIL=1
            fi

            echo "üîí Generating SARIF for $IMG"
            trivy image --format sarif --output "$OUTPUT_SARIF" "$IMG"
          done

          # Create status file
          if [ $FAIL -eq 0 ]; then
            echo "success" > trivy-results/status.txt
          else
            echo "fail" > trivy-results/status.txt
          fi

          echo "Trivy scan completed"
          exit $FAIL

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results
          retention-days: 1

      - name: Upload SARIF results to GitHub Security
        if: always()
        run: |
          set -euo pipefail
          IMAGES='${{ needs.detect-changed-images.outputs.images }}'
          
          # Upload each SARIF file individually with unique categories
          INDEX=0
          for IMG in $(echo "$IMAGES" | jq -r '.[]'); do
            SAFE_NAME=$(echo "$IMG" | sed 's|[:/\.]|_|g')
            SARIF_FILE="trivy-results/trivy-$SAFE_NAME.sarif"
            
            if [ -f "$SARIF_FILE" ]; then
              echo "Uploading SARIF for $IMG with category trivy-$INDEX"
              
              # Use the upload-sarif action for each file individually
              gh api \
                --method POST \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/${{ github.repository }}/code-scanning/sarifs" \
                --input <(jq --arg category "trivy-$INDEX" \
                  --arg ref "${{ github.sha }}" \
                  --arg commit_sha "${{ github.sha }}" \
                  '. + {
                    "ref": $ref,
                    "commit_sha": $commit_sha,
                    "category": $category
                  }' "$SARIF_FILE") || echo "Failed to upload $SARIF_FILE"
              
              INDEX=$((INDEX + 1))
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trivy-pr-comment:
    name: Update PR comment
    runs-on: ubuntu-24.04
    needs: [detect-changed-images, trivy-scan]
    if: always() && github.event_name == 'pull_request' && needs.detect-changed-images.outputs.has_changes == 'true'
    permissions:
      pull-requests: write
    steps:
      - name: Download scan results
        uses: actions/download-artifact@v5
        with:
          name: trivy-results
          path: results

      - name: Build PR comment
        run: |
          STATUS=$(cat results/status.txt 2>/dev/null || echo "fail")
          if [[ "$STATUS" == "success" ]]; then
            HEADER="## ‚úÖ Container Image Security Scan Passed"
          else
            HEADER="## ‚ùå Container Image Security Scan Failed"
          fi

          BODY="$HEADER\n\nScanned the following updated images:\n"

          for f in results/trivy-*.txt; do
            IMG=$(head -n 1 "$f" | sed 's/^IMAGE=//')
            if [ -s "$f" ]; then
              BODY="$BODY\n\n### \`$IMG\`\n<details><summary>Details</summary>\n\n\`\`\`\n$(tail -n +2 "$f")\n\`\`\`\n</details>"
            else
              BODY="$BODY\n\n### \`$IMG\`\n‚úÖ No vulnerabilities were detected."
            fi
          done

          BODY="$BODY\n\nüìä Check the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning?query=pr%3A${{ github.event.pull_request.number }}) for full SARIF reports."
          echo -e "$BODY" > comment.md

      - name: Comment PR with Trivy results
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: comment.md

  build-config:
    name: Build
    runs-on: ubuntu-24.04
    steps:
      - name: Free diskspace
        uses: easimon/maximize-build-space@master
        with:
          build-mount-path: /nix
          root-reserve-mb: 5120
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
      - uses: actions/checkout@v5
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: "experimental-features = nix-command flakes pipe-operators"
      - name: Restore and cache Nix store
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 1073741824
          purge: false
      - name: Build Template Config
        run: nix build ./template#homeConfigurations.myhost.activationPackage
      - name: Build Full Config
        run: nix build .#homeConfigurations.ci.activationPackage

  check_flake:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: "experimental-features = nix-command flakes pipe-operators"
      - name: Check Flake
        run: nix flake check --keep-going

  build-docs:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: "experimental-features = nix-command flakes pipe-operators"
      - name: Build docs
        run: nix build .#book -o result/book
      - name: Build search
        run: nix build .#search -o result/search
      - name: Upload docs
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./result

  publish-docs:
    needs: build-docs
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    steps:
      - uses: actions/deploy-pages@v4 | sort -u || true)

          images_json="[]"
          has_changes="false"

          if [ -n "$CHANGED_IMAGES" ]; then
            has_changes="true"
            while IFS= read -r image; do
              if [ -n "$image" ]; then
                images_json=$(echo "$images_json" | jq -c --arg img "$image" '. + [$img]')
              fi
            done <<< "$CHANGED_IMAGES"
          fi

          echo "Final changed images found:"
          echo "$CHANGED_IMAGES"
          echo ""
          echo "JSON output: $images_json"

          echo "images=$images_json" >> $GITHUB_OUTPUT
          echo "has_changes=$has_changes" >> $GITHUB_OUTPUT

  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-24.04
    needs: detect-changed-images
    if: needs.detect-changed-images.outputs.has_changes == 'true'
    permissions:
      security-events: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.4

      - name: Scan changed images
        run: |
          set -euo pipefail
          IMAGES='${{ needs.detect-changed-images.outputs.images }}'
          mkdir -p trivy-results
          FAIL=0

          for IMG in $(echo "$IMAGES" | jq -r '.[]'); do
            SAFE_NAME=$(echo "$IMG" | sed 's|[:/\.]|_|g')
            OUTPUT_TXT="trivy-results/trivy-$SAFE_NAME.txt"
            OUTPUT_SARIF="trivy-results/trivy-$SAFE_NAME.sarif"

            echo "IMAGE=$IMG" > "$OUTPUT_TXT"

            echo "üîç Scanning $IMG (table output)"
            if ! trivy image --exit-code 1 --severity CRITICAL,HIGH --format table "$IMG" | tee -a "$OUTPUT_TXT"; then
              FAIL=1
            fi

            echo "üîí Generating SARIF for $IMG"
            trivy image --format sarif --output "$OUTPUT_SARIF" "$IMG"
          done

          # Create status file
          if [ $FAIL -eq 0 ]; then
            echo "success" > trivy-results/status.txt
          else
            echo "fail" > trivy-results/status.txt
          fi

          echo "Trivy scan completed"
          exit $FAIL

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results
          retention-days: 1

      - name: Upload SARIF results to GitHub Security
        if: always()
        run: |
          set -euo pipefail
          IMAGES='${{ needs.detect-changed-images.outputs.images }}'
          
          # Upload each SARIF file individually with unique categories
          INDEX=0
          for IMG in $(echo "$IMAGES" | jq -r '.[]'); do
            SAFE_NAME=$(echo "$IMG" | sed 's|[:/\.]|_|g')
            SARIF_FILE="trivy-results/trivy-$SAFE_NAME.sarif"
            
            if [ -f "$SARIF_FILE" ]; then
              echo "Uploading SARIF for $IMG with category trivy-$INDEX"
              
              # Use the upload-sarif action for each file individually
              gh api \
                --method POST \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/${{ github.repository }}/code-scanning/sarifs" \
                --input <(jq --arg category "trivy-$INDEX" \
                  --arg ref "${{ github.sha }}" \
                  --arg commit_sha "${{ github.sha }}" \
                  '. + {
                    "ref": $ref,
                    "commit_sha": $commit_sha,
                    "category": $category
                  }' "$SARIF_FILE") || echo "Failed to upload $SARIF_FILE"
              
              INDEX=$((INDEX + 1))
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trivy-pr-comment:
    name: Update PR comment
    runs-on: ubuntu-24.04
    needs: [detect-changed-images, trivy-scan]
    if: always() && github.event_name == 'pull_request' && needs.detect-changed-images.outputs.has_changes == 'true'
    permissions:
      pull-requests: write
    steps:
      - name: Download scan results
        uses: actions/download-artifact@v5
        with:
          name: trivy-results
          path: results

      - name: Build PR comment
        run: |
          STATUS=$(cat results/status.txt 2>/dev/null || echo "fail")
          if [[ "$STATUS" == "success" ]]; then
            HEADER="## ‚úÖ Container Image Security Scan Passed"
          else
            HEADER="## ‚ùå Container Image Security Scan Failed"
          fi

          BODY="$HEADER\n\nScanned the following updated images:\n"

          for f in results/trivy-*.txt; do
            IMG=$(head -n 1 "$f" | sed 's/^IMAGE=//')
            if [ -s "$f" ]; then
              BODY="$BODY\n\n### \`$IMG\`\n<details><summary>Details</summary>\n\n\`\`\`\n$(tail -n +2 "$f")\n\`\`\`\n</details>"
            else
              BODY="$BODY\n\n### \`$IMG\`\n‚úÖ No vulnerabilities were detected."
            fi
          done

          BODY="$BODY\n\nüìä Check the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning?query=pr%3A${{ github.event.pull_request.number }}) for full SARIF reports."
          echo -e "$BODY" > comment.md

      - name: Comment PR with Trivy results
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: comment.md

  build-config:
    name: Build
    runs-on: ubuntu-24.04
    steps:
      - name: Free diskspace
        uses: easimon/maximize-build-space@master
        with:
          build-mount-path: /nix
          root-reserve-mb: 5120
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
      - uses: actions/checkout@v5
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: "experimental-features = nix-command flakes pipe-operators"
      - name: Restore and cache Nix store
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 1073741824
          purge: false
      - name: Build Template Config
        run: nix build ./template#homeConfigurations.myhost.activationPackage
      - name: Build Full Config
        run: nix build .#homeConfigurations.ci.activationPackage

  check_flake:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: "experimental-features = nix-command flakes pipe-operators"
      - name: Check Flake
        run: nix flake check --keep-going

  build-docs:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: "experimental-features = nix-command flakes pipe-operators"
      - name: Build docs
        run: nix build .#book -o result/book
      - name: Build search
        run: nix build .#search -o result/search
      - name: Upload docs
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./result

  publish-docs:
    needs: build-docs
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    steps:
      - uses: actions/deploy-pages@v4